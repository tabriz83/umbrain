<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>우리집에 GDB 있는데... 메모리 보고갈래? (2)</title>
    <meta name="description" content="Into the Brain of taBRis - Memory Repository." />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/umbrain/assets/images/Favicon.png" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/umbrain/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/umbrain/assets/css/syntax.css" />
    
    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/umbrain/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/umbrain/page2/" />

    <meta property="og:site_name" content="Into the Brain of taBRis" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Into the Brain of taBRis" />
    <meta property="og:description" content="Memory Repository." />
    <meta property="og:url" content="/umbrain/" />
    <meta property="og:image" content="/umbrain/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Into the Brain of taBRis" />
    <meta name="twitter:description" content="Memory Repository." />
    <meta name="twitter:url" content="/umbrain/" />
    <meta name="twitter:image:src" content="/umbrain/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Into the Brain of taBRis",
    "url": "/umbrain/",
    "image": "/umbrain/assets/images/cover1.jpg",
    "description": "Memory Repository."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Into the Brain of taBRis" href="/umbrain/rss.xml" />

</head>
<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/umbrain/">Main</a></li>
        <li class="nav-security " role="presentation"><a href="/umbrain/tag/Security">Security</a></li>
        <li class="nav-unclassified " role="presentation"><a href="/umbrain/tag/Unclassified">Unclassified</a></li>
        <li class="nav-author " role="presentation"><a href="/umbrain/author/tabris">Author</a></li>
    </ul>
	<a class="subscribe-button icon-feed" href="/umbrain/rss.xml">Subscribe</a>
	<!— Html Elements for Search -->
	<div class="search-container">
	<input type="text" id="search-input" size="23" placeholder="Search...">
	<ul id="results-container"></ul>
	<!-- Script pointing to jekyll-search.js -->
	<script src="/umbrain//dest/jekyll-search.js" type="text/javascript"></script>
	
	<script type="text/javascript">
		  SimpleJekyllSearch({
			searchInput: document.getElementById('search-input'),
			resultsContainer: document.getElementById('results-container'),
			json: '/umbrain//search.json',
			searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
			noResultsText: 'No results found',
			limit: 1000,
			fuzzy: false,
			exclude: ['Welcome']
		  })
	</script>
	</div>
	
</div>
<span class="nav-cover"></span>

    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/umbrain/assets/images/cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/umbrain/"><img src="/umbrain/assets/images/logo.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-Security">

        <header class="post-header">
            <h1 class="post-title">우리집에 GDB 있는데... 메모리 보고갈래? (2)</h1>
            <section class="post-meta">
            <!-- <a href='/umbrain/'>taBRis</a> -->
            <time class="post-date" datetime="2017-01-24">24 Jan 2017</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/umbrain/tag/Security'>Security</a>,
                       
                
                    
                       <a href='/umbrain/tag/System Hacking'>System hacking</a>,
                       
                
                    
                       <a href='/umbrain/tag/Reversing'>Reversing</a>,
                       
                
                    
                       <a href='/umbrain/tag/Guide'>Guide</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <p><strong>출처 : <a href="https://bpsecblog.wordpress.com/2016/04/04/gdb_memory_2/">우리집에 GDB 있는데... 메모리 보고갈래? (2) - Hackerz on the Ship</a></strong></p>

<h2>Season 1. 우리집에 GDB있는데... 메모리 보고 갈래?</h2>

<h3>DAY #2. 애프터 신청 (~~너~~ gdb 사용법, 갖고싶다.. 너란 stack)</h3>

<p><br>
<img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-intro.png" alt="*인트로*">
<br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">//tomato.c

#include &lt;string.h&gt;
#include &lt;stdio.h&gt;&#39;

void func2() {
    puts(&quot;func2()&quot;);
}

void sum(int a, int b) {
    printf(&quot;sum : %d\n&quot;, a+b);
    func2();
}

int main(int argc, char *argv[]) {

    int num=0;
    char arr[10];

    sum(1,2);
    strcpy(arr,argv[1]);
    printf(&quot;arr: %s\n&quot;, arr);
    if(num==1){
        system(&quot;/bin/sh&quot;);
    }
    return 0;
}
</code></pre></div>
<p><br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">in09@ubuntu:~/bpsecblog/day2$ gcc -fno-stack-protector -o tomato tomato.c
</code></pre></div>
<blockquote>
<p><strong>-fno-stack-protector 옵션을 포함하는 이유</strong><br>
gcc가 스택을 보호하기 위해 ‘canary’라는 것을 삽입해요.<br>
함수 내에서 사용하는 스택 프레임과 return address 사이에<br>
canary를 넣어염.</p>

<p>Buffer Overflow가 발생해 canary를 덮었을 때,<br>
이를 감지하고 프로그램을 강제 종료 해 버린답니당.</p>

<p>이를 <strong>SSP</strong>(Stack Smashing Protection)이라고 해요.</p>

<p>여기에선 오버플로우가 발생해도 프로그램이 강제 종료되지 않도록,<br>
<strong>–fno-stack-protector</strong> 옵션을 사용해 <strong>보호기법을 해제</strong>한겁니답.</p>

<p>반대로 모든 프로시져에 이 <strong>보호기법을 적용</strong>하기 위해서는,<br>
<strong>-fstack-protector-all</strong> 옵션을 사용하세염</p>

<p><a href="https://bpsecblog.wordpress.com/2016/03/26/watermelon-feat-%ec%b6%9c%ec%a0%9c%ec%9e%90-in09/">[Go to Watermelon]</a><br>
(CodeGate2016 watermelon writeup에서<br>
canary에 대한 자세한 내용이 있으니 참고하셔도 좋습니당!)</p>
</blockquote>

<p><br></p>

<p>이제 GDB를 활용해보도록 할까욤?</p>

<hr>

<h4>Ch 1. ~~너~~  gdb 사용법</h4>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-intro2.png" alt=""></p>

<blockquote>
<p>하라니까 하겠는데.<br>
근데 GDB를 왜 써야되는데?</p>
</blockquote>

<p><br></p>

<p>지..진정하세요.</p>

<p>gdb는 오픈소스로 공개되어있는 무료 디버거랍니다.<br>
아 디버거가 뭐냐거여?</p>

<p>님들 해답지보고 공부할 때,<br>
왜 이러저러하게 이 답이 도출이 되는지 보잖아요.</p>

<p>디버거도 그런검미다.<br>
코드에서 이 라인을 실행할 때, 어떤 값이 어떤 메모리 주소에 올라가고<br>
그 과정을 보여주는거져.</p>

<p>컴퓨터 계의 X-RAY랄까?  </p>

<p>gdb를 쓰면 물론 콘솔 기반이라.. 빡치긴 해여..<br>
ida 봐봐여… 아름답잖아요..</p>

<p>하지만 ELF 파일과 같은 Linux 기반의 실행파일을<br>
동적으로 따라가며 분석할 때 gdb 참 쓸만하져.</p>

<p>그래서 이거 씀미다.</p>

<p>긍까 쫄지말고 긔긔.</p>

<hr>

<p>GDB로 tomato를 실행시켜봅시당.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">in09@ubuntu:~/bpsecblog/day2$ gdb ./tomato
</code></pre></div>
<p>이건 그냥 gdb로 tomato에 붙은 것에 불과해여.<br>
아직 우리의 토마토는 실행되지 않았담미다.</p>

<p>일단 gdb 켜봤으면 뭐.. 어셈도 한번 봐주고,<br>
tomato를 실행하기 전에 이것 저것 설정도 해줘야쥬?</p>

<p>일단 보기 편하게 어셈 코드를 intel 형식으로 설정해<br>
main을 출력해 보겠습니답.ㅎㅎ</p>

<blockquote>
<p><strong>set disassembly-flavor [명령어 형식]</strong><br>
어셈블리 코드 문법을 설정하는 명령어.<br>
x86에서 Intel과 at&amp;t 둘 중 하나를 골라 쓰면 됨.<br>
[명령어 형식의 예] : intel, att</p>

<p><strong>disas [함수이름]</strong><br>
함수의 어셈블리 코드를 보는 명령어.</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) set disassembly-flavor intel  
(gdb) disas main  
      Dump of assembler code for function main:  
         0x080484e6 &lt;+0&gt;: push   ebp  
         0x080484e7 &lt;+1&gt;: mov    ebp,esp  
         0x080484e9 &lt;+3&gt;: and    esp,0xfffffff0  
         0x080484ec &lt;+6&gt;: sub    esp,0x20  
         0x080484ef &lt;+9&gt;: mov    DWORD PTR [esp+0x1c],0x0  
         0x080484f7 &lt;+17&gt;: mov    DWORD PTR [esp+0x4],0x2  
         0x080484ff &lt;+25&gt;: mov    DWORD PTR [esp],0x1  
         0x08048506 &lt;+32&gt;: call   0x80484c1 &lt;sum&gt;  
         0x0804850b &lt;+37&gt;: mov    eax,DWORD PTR [ebp+0xc]  
         0x0804850e &lt;+40&gt;: add    eax,0x4  
         0x08048511 &lt;+43&gt;: mov    eax,DWORD PTR [eax]  
         0x08048513 &lt;+45&gt;: mov    DWORD PTR [esp+0x4],eax  
         0x08048517 &lt;+49&gt;: lea    eax,[esp+0x12]  
         0x0804851b &lt;+53&gt;: mov    DWORD PTR [esp],eax  
         0x0804851e &lt;+56&gt;: call   0x8048360 &lt;strcpy@plt&gt;  
         0x08048523 &lt;+61&gt;: lea    eax,[esp+0x12]  
         0x08048527 &lt;+65&gt;: mov    DWORD PTR [esp+0x4],eax  
         0x0804852b &lt;+69&gt;: mov    DWORD PTR [esp],0x8048602  
         0x08048532 &lt;+76&gt;: call   0x8048350 &lt;printf@plt&gt;  
         0x08048537 &lt;+81&gt;: cmp    DWORD PTR [esp+0x1c],0x1  
         0x0804853c &lt;+86&gt;: jne    0x804854a &lt;main+100&gt;  
         0x0804853e &lt;+88&gt;: mov    DWORD PTR [esp],0x804860b  
         0x08048545 &lt;+95&gt;: call   0x8048380 &lt;system@plt&gt;  
         0x0804854a &lt;+100&gt;: mov    eax,0x0  
         0x0804854f &lt;+105&gt;: leave  
         0x08048550 &lt;+106&gt;: ret  
      End of assembler dump.
</code></pre></div>
<p>메인이 이렇게 구성되어 있네요.</p>

<p>main에 breakpoint를 걸고 한번 실행해 볼까요?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">0x080484e6 &lt;+0&gt;: push   ebp
</code></pre></div>
<p>이게 main의 시작이잖아요?</p>

<blockquote>
<p><strong>b *[메모리주소]</strong><br>
breakpoint를 거는 명령.</p>

<p><u>[메모리 주소]</u>나 <u>[함수의 이름]</u> 혹은,<br>
이를 기준으로 한 <u>[offset &lt;+0&gt;]</u>으로<br>
breakpoint를 걸어도 됩니당.</p>

<p>* breakpoint를 걸 땐, 주소 앞에 *를 붙이세요!</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) b *main
Breakpoint 1 at 0x80484e6
(gdb) b *0x080484e6
Note: breakpoint 1 also set at pc 0x80484e6
Breakpoint 2 at 0x80484e6
(gdb) b *main+0
Note: breakpoints 1 and 2 also set at pc 0x80484e
Breakpoint 3 at 0x80484e6
</code></pre></div>
<p>모두 똑같은 곳에 breakpoint가 걸렸죠?
<br></p>

<p><strong>breakpoint</strong> 정보를 확인해볼게용</p>

<blockquote>
<p><strong>info b</strong><br>
breakpoint 정보를 열람할 수 있는 명령어</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) info b
Num     Type           Disp Enb Address    What
1       breakpoint     keep y   0x080484e6 &lt;main&gt;
2       breakpoint     keep y   0x080484e6 &lt;main&gt;
3       breakpoint     keep y   0x080484e6 &lt;main&gt;
</code></pre></div>
<p><br></p>

<p><strong>Breakpoint</strong>가 중복되니 삭제해보도록 하겠습니당</p>

<blockquote>
<p><strong>d (breakpoint 번호)</strong><br>
breakpoint를 삭제 할 수 있는 명령어</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) d 2
(gdb) d 3
(gdb) info b
Num     Type           Disp Enb Address    What
1       breakpoint     keep y   0x080484e6 &lt;main&gt;
</code></pre></div>
<p><br></p>

<p>이제 <strong>프로그램을 실행</strong>해볼게요!
이제야 비로소.. 아 토마토 다 뿔었겠네. ㅡㅡ</p>

<blockquote>
<p><strong>run [매개변수]</strong><br>
gdb 내부에서 프로그램 실행</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) run aaaaaaaaaa
Starting program: /home/in09/bpsecblog/day2/tomato aaaaaaaaaa
Breakpoint 1, 0x080484e6 in main ()
(gdb)
</code></pre></div>
<p>헌데 명령행 인자로 main의 매개변수에 값이 넘어가죠?<br>
그래서 “aaaaaaaaa” 스트링을 넘겨준 거예요.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">in09@ubuntu:~/bpsecblog/day2$ ./tomato aaaaaaaaaa
 sum : 3
 func2()
 arr: aaaaaaaaaa 
</code></pre></div>
<p>터미널에서 위와 같이 실행하는 것과 동일한거죠!
<br></p>

<p>현재 우리 실행 흐름이 어디에 있는지 EIP를 확인해볼게요! Main에 멈춰있어야겠죠?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">gdb) disas main
Dump of assembler code for function main:
=&gt; 0x080484e6 &lt;+0&gt;: push   ebp
   0x080484e7 &lt;+1&gt;: mov    ebp,esp
   0x080484e9 &lt;+3&gt;: and    esp,0xfffffff
   0x080484ec &lt;+6&gt;: sub    esp,0x20
</code></pre></div>
<p>=&gt; 화살표가 보이졍?<br>
아주 잘 멈춰져있네요.<br>
인스트럭션을 한줄 한줄 실행해볼게염.</p>

<blockquote>
<p><strong>ni</strong>
다음 인스트럭션 실행</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) ni
0x080484e7 in main ()
(gdb) ni
0x080484e9 in main ()
(gdb) disas main
Dump of assembler code for function main:
   0x080484e6 &lt;+0&gt;: push   ebp
   0x080484e7 &lt;+1&gt;: mov    ebp,esp
=&gt; 0x080484e9 &lt;+3&gt;: and    esp,0xfffffff0
   0x080484ec &lt;+6&gt;: sub    esp,0x20
</code></pre></div>
<p>현재 EIP가 멈춰져있는 곳 이 전의 밑줄 친 <u>인스트럭션</u>을 보면,<br>
esp 값을 ebp 값에 저장하고 있죠?</p>

<p>esp, ebp는 스택과 관련한 레지스터잖아요!<br>
그 메모리에 어떤 값이 담겨있는지 gdb로 확인해보도록 하게씀미당.
<br></p>

<p>그 전에 메모리 출력 방식에 대해 정리하고 가도록 할게요.<br>
<strong>몇 바이트</strong>만큼 그리고 <strong>몇 진법</strong>으로 출력할 것인지 정해 옵션을 주어 출력해 주면 됨미다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/b 0x080484e6
0x80484e6 &lt;main&gt;: 0x55
(gdb) x/h 0x080484e6
0x80484e6 &lt;main&gt;: 0x8955
(gdb) x/w 0x080484e6
0x80484e6 &lt;main&gt;: 0x83e58955
</code></pre></div>
<p><br></p>

<p>해당 메모리 주소의 값을 각각 1바이트, 2바이트, 4바이트만큼 출력해주었습니다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/x 0x080484e6
0x80484e6 &lt;main&gt;: 0x83e58955
(gdb) x/u 0x080484e6
0x80484e6 &lt;main&gt;: 2212858197
</code></pre></div>
<p><br></p>

<p>해당 메모리 주소 값을 16진수, 10진수로 출력해주었습니다.<br>
보통 이렇게들 씁니당.<br>
(진법 옵션이든 바이트 옵션이든 생략되면 이전 옵션으로 실행해줍니다.)</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/wx 0x080484e6
0x80484e6 &lt;main&gt;: 0x83e58955
(gdb) x/4b 0x080484e6
0x80484e6 &lt;main&gt;: 0x55 0x89 0xe5 0x83
</code></pre></div>
<p><br></p>

<blockquote>
<p><strong>Byte Ordering [Big Endian / Little Endian]</strong>  </p>

<p>헙.. 근데 순서가 조금 이상하죠?</p>

<p>4바이트 출력한 것과 1바이트씩 4개를 출력한 것과 순서가 반대예요!<br>
<strong>바이트 오더링</strong> 개념에 대해 이해를 해야 하는데요.<br>
Intel CPU는 바이트를 배열할 때 <u>거꾸로 쓰게</u> 됩니다.<br>
예를 들어 0x12345678을 저장한다고 하면, <strong>0x78563412</strong>와 같이 거꾸로 저장하게 됩니다.<br>
이를 <strong><u>Little Endian</u></strong>이라 지칭합니다.</p>

<p>반면, gdb는 디버깅 시에 보기 편하게 하기 위해서<br>
Big Endian 형식으로 <strong>0x12345678</strong>와 같이 출력해주기 때문에,<br>
1바이트씩 출력할 때와 4바이트로 출력할 때 달리 보이는 거예요.</p>

<p>• 참고로 네트워크 상에서는 <u><strong>Big Endian</strong></u> 형식의 바이트 오더링을 사용합니다.</p>
</blockquote>

<p><br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/4wx $esp
0xbffff6b8: 0x00000000 0xb7e2fa83 0x00000002 0xbffff754
</code></pre></div>
<p>특정 레지스터를 기준으로 메모리 값을 보고 싶으면,<br>
$register_name으로 출력해볼 수 있습니당.
<br></p>

<p>다음은 ebp와 esp를 출력하는 것이고,<br>
info reg 혹은 i r은 레지스터 정보를 출력하는 명령입니답.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/wx $ebp
0xbffff6b8: 0x00000000
(gdb) x/wx $esp
0xbffff6b8: 0x00000000
(gdb) info reg $ebp
ebp            0xbffff6b8 0xbffff6b8
(gdb) i r $ebp $esp
ebp            0xbffff6b8 0xbffff6b8
esp            0xbffff6b8 0xbffff6b8
(gdb) i r
eax            0x2 2
ecx            0x7ce225d5 2095195605
edx            0xbffff6e4 -1073744156
ebx            0xb7fc0000 -1208221696
esp            0xbffff6b8 0xbffff6b8
ebp            0xbffff6b8 0xbffff6b8
esi            0x0 0
edi            0x0 0
eip            0x8048480 0x8048480 &lt;main+3&gt;
eflags         0x246 [ PF ZF IF ]
cs             0x73 115
ss             0x7b 123
ds             0x7b 123
es             0x7b 123
fs             0x0 0
gs             0x33 51
</code></pre></div>
<p><br></p>

<p>자.. 이제 gdb 사용법은 거진 다 익힌 것 같아요.</p>

<p>이제 우리 좀 더 알아가볼까요..?ㅎㅎ</p>

<hr>

<h4>Ch 2. 갖고싶다.. 너란 stack..</h4>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-1.png" alt="">
<em>[그림 1] Stack과 관련한 레지스터</em>
<br></p>

<p>• 현재 EIP 상황(main 2줄 실행)
<code>
  0x080484e6 &lt;+0&gt;: push   ebp
  0x080484e7 &lt;+1&gt;: mov    ebp,esp
=&gt;0x080484e9 &lt;+3&gt;: and    esp,0xfffffff0
  0x080484ec &lt;+6&gt;: sub    esp,0x20
  0x080484ef &lt;+9&gt;: mov    DWORD PTR [esp+0x1c],0x0
  0x080484f7 &lt;+17&gt;: mov    DWORD PTR [esp+0x4],0x2
  0x080484ff &lt;+25&gt;: mov    DWORD PTR [esp],0x1
  0x08048506 &lt;+32&gt;: call   0x80484c1 &lt;sum&gt;
</code>
<br></p>

<h5>1. 스택의 시작</h5>

<blockquote>
<p><em>PUSH EBP</em><br>
<em>MOV EBP, ESP</em></p>
</blockquote>

<p>단 두 줄의 인스트럭션만 실행이 되었기 때문에 별 건 없져?<br>
하지만 저 단 두 줄의 어셈이 의미하는 바는 상당합니다.<br>
바로 <mark>&#39;스택(프레임)이 생성&#39;</mark>이 된다는 것이죠.</p>

<p>저 두 줄의 의미는,  </p>

<blockquote>
<p><mark>&#39;함수가 실행이 될 때, 그 이전의 ebp(sfp)를 스택에 push하고<br>
현재 esp를 ebp에 저장하라.(새로운 ebp 생성!)&#39;</mark></p>
</blockquote>

<p>이라는 뜻임미당.
<br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">0x08048506 &lt;+32&gt;: call   0x80484c1 &lt;sum&gt;
</code></pre></div>
<p>여기에 breakpoint를 걸고 실행시킨 후 스택의 상황을 보겠습니답.<br>
breakpoint까지 한 번에 뛰려면 c 명령을 사용하면 됩니당.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) b *main+32
Breakpoint 2 at 0x8048506
(gdb) c
Continuing.
Breakpoint 2, 0x08048506 in main ()
(gdb) disas main
Dump of assembler code for function main:
  0x080484e6 &lt;+0&gt;: push   ebp
  0x080484e7 &lt;+1&gt;: mov    ebp,esp
  0x080484e9 &lt;+3&gt;: and    esp,0xfffffff0 
  0x080484ec &lt;+6&gt;: sub    esp,0x20
  0x080484ef &lt;+9&gt;: mov    DWORD PTR [esp+0x1c],0x0
  0x080484f7 &lt;+17&gt;: mov    DWORD PTR [esp+0x4],0x2
  0x080484ff &lt;+25&gt;: mov    DWORD PTR [esp],0x1
=&gt;0x08048506 &lt;+32&gt;: call   0x80484c1 &lt;sum&gt;
</code></pre></div>
<p>원하는 곳에 멈춰잇쪄?</p>

<p>• sum이 call되기 전 상황</p>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-2.png" alt="">
<em>[그림 2] sum이 call되기 전 상황</em>
<br></p>

<p>그리고 sum 함수 안으로 들어가보도록 하겠습니다.</p>

<p>call을 할 때는, 다음 인스트럭션의 주소를 스택에 쌓고 가죠?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">0x08048506 &lt;+32&gt;: call   0x80484c1 &lt;sum&gt;
0x0804850b &lt;+37&gt;: mov    eax,DWORD PTR [ebp+0xc]
</code></pre></div>
<p>call sum에 breakpoint를 걸고 (0x080484c1)<br>
sum 안으로 들어가면,<br>
<strong>스택에 ESP(0x00000001)위에 0x0804850b가 쌓였을 거예여.</strong></p>

<p>확인해볼까욤?</p>

<p>• sum이 call된 후의 상황</p>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-3.png" alt="">
<em>[그림 3] sum이 call된 후의 상황</em>
<br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/10i $eip
=&gt; 0x80484c1 &lt;sum&gt;: push   ebp
   0x80484c2 &lt;sum+1&gt;: mov    ebp,esp
   0x80484c4 &lt;sum+3&gt;: sub    esp,0x18
   0x80484c7 &lt;sum+6&gt;: mov    eax,DWORD PTR [ebp+0xc]
...생략...
(gdb) ni
</code></pre></div>
<p>sum 함수 안으로 들어왔쪄?</p>

<p>오 역시나..
<code>
Push ebp
mov  ebp, esp
</code>
하고 있어욤.</p>

<p><em>Push ebp</em>를 실행하면,<br>
그 이전 스택 프레임(main)의 ebp가<br>
sum의 스택 프레임에 push될거예여.</p>

<p>즉, main의 ebp 0xbffff758가 esp에 들어가겠쬬?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) ni
(gdb) x/wx $esp
0xbffff728: 0xbffff758
</code></pre></div>
<p>오오… 마쟈마쟈ㅠㅠ</p>

<p>그리고 <code>mov ebp, esp</code>를 하면,<br>
현재 esp를 sum stack frame의 바닥<br>
즉, sum의 ebp로 만들어주겠져?</p>

<p>그러므로 sum의 ebp에는 main의 ebp가 있게되겠져.</p>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-4.png" alt="">
<em>[그림 4] sum 함수에 들어갔을 때 ebp의 변화</em>
<br></p>

<p>이제 새로운 sum의 스택 프레임이 생성되었습니다!!<br>
확인해볼까요?</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/15wx $ebp
0xbffff728: 0xbffff758 0x0804850b 0x00000001 0x00000002
0xbffff738: 0xbffff800 0xb7e4942d 0xb7fc03c4 0xb7fff000
0xbffff748: 0x0804856b 0x00000000 0x08048560 0x00000000
0xbffff758: 0x00000000 0xb7e2fa83 0x00000002
</code></pre></div>
<blockquote>
<p>0xbffff758 : <strong>sum의 stack frame</strong></p>

<blockquote>
<p>0x0804850b 0x00000001 0x00000002<br>
0xbffff800 0xb7e4942d 0xb7fc03c4 0xb7fff000<br>
0x0804856b 0x00000000 0x08048560 0x00000000<br>
0x00000000 : <strong>main의 stack frame</strong></p>
</blockquote>
</blockquote>

<p>이제 새로운 sum의 스택 프레임이 생성되었습니다!!<br>
(현재 tomato.c에서 sum(1,2)라인이 실행 중이겠져?)
<br></p>

<p>상단의 스택을 첫줄만 간추려보도록 하겠습니당.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">0xbffff728: 0xbffff758 0x0804850b 0x00000001 0x00000002
</code></pre></div>
<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-5.png" alt="">
<em>[그림 5] ebp를 기준으로 보쎄용</em>
<br></p>

<p>보이심까?</p>

<blockquote>
<p><mark>새로운 스택 프레임의 ebp를 기준으로<br>
<strong>return address</strong>는 <strong>ebp-4</strong>,<br>
<u>매개인자</u>는 <u>ebp-8</u>, ebp -12와 같이 들어가게 됩니다!</mark></p>
</blockquote>

<p>꼭 기억하세욤~</p>

<blockquote>
<p><strong>c</strong><br>
프로그램이 gdb로 run된 이후에<br>
다음 중단점까지 실행하는 명령어</p>
</blockquote>

<p><br></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/10i $eip
=&gt; 0x80484c4 &lt;sum+3&gt;: sub    esp,0x18
   0x80484c7 &lt;sum+6&gt;: mov    eax,DWORD PTR [ebp+0xc]
   0x80484ca &lt;sum+9&gt;: mov    edx,DWORD PTR [ebp+0x8]
   0x80484cd &lt;sum+12&gt;: add    eax,edx
   0x80484cf &lt;sum+14&gt;: mov    DWORD PTR [esp+0x4],eax
   0x80484d3 &lt;sum+18&gt;: mov    DWORD PTR [esp],0x80485f8
   0x80484da &lt;sum+25&gt;: call   0x8048350 &lt;printf@plt&gt;
   0x80484df &lt;sum+30&gt;: call   0x80484ad &lt;func2&gt;
   0x80484e4 &lt;sum+35&gt;: leave 
   0x80484e5 &lt;sum+36&gt;: ret
(gdb) b *0x080484ad
Breakpoint 4 at 0x80484ad
(gdb) c
Continuing.
sum : 3
Breakpoint 4, 0x080484ad in func2 ()
(gdb) x/i $eip
=&gt; 0x80484ad &lt;func2&gt;: push   ebp
(gdb) ni
0x080484ae in func2 ()
(gdb) x/i $eip
=&gt; 0x80484ae &lt;func2+1&gt;: mov    ebp,esp
(gdb) ni
   0x080484b0 in func2 ()
</code></pre></div>
<p>자.. 또 sum 안에서 func2를 호출했어요.<br>
그럼 아마 스택의 모습은<br>
<strong>| func2 stack frame | sum stack frame | main stack frame|</strong> 과 같이 되겠져?</p>

<p>확인해볼게염.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/23wx $ebp
0xbffff708: 0xbffff728 0x080484e4 0x080485f8 0x00000003
0xbffff718: 0x00000001 0x0804831d 0xbffff914 0x0000002f
0xbffff728: 0xbffff758 0x0804850b 0x00000001 0x00000002
0xbffff738: 0xbffff800 0xb7e4942d 0xb7fc03c4 0xb7fff000
0xbffff748: 0x0804856b 0x00000000 0x08048560 0x00000000
0xbffff758: 0x00000000 0xb7e2fa83 0x00000002 
</code></pre></div>
<blockquote>
<p>0xbffff728 : <strong>func2의 stack frame</strong>  </p>

<blockquote>
<p>0x080484e4 0x080485f8 0x00000003<br>
0x00000001 0x0804831d 0xbffff914 0x0000002f<br>
0xbffff758 : <strong>sum의 stack frame</strong>  </p>

<blockquote>
<p>0x0804850b 0x00000001 0x00000002<br>
0xbffff800 0xb7e4942d 0xb7fc03c4 0xb7fff000<br>
0x0804856b 0x00000000 0x08048560 0x00000000<br>
0x00000000 0xb7e2fa83 0x00000002 : <strong>main의 stack frame</strong></p>
</blockquote>
</blockquote>
</blockquote>

<p>시작이 있으면 끝이 있겠져?<br>
스택의 프레임이 시작되는,<br>
<code>Push ebp</code><br>
<code>mov ebp, esp</code>를 자세히 살펴보았으니,</p>

<p>스택 프레임의 끝<br>
<strong>Leave</strong><br>
<strong>Ret</strong>을 살펴보도록 하겠습니다.</p>

<p><br></p>

<h5>2. stack의 끝</h5>

<blockquote>
<p><strong>Leave</strong>
<strong>Ret</strong></p>
</blockquote>

<p><strong>• 현재 EIP 상황</strong></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) disas func2
Dump of assembler code for function func2:
   0x080484ad &lt;+0&gt;: push   ebp
   0x080484ae &lt;+1&gt;: mov    ebp,esp
   0x080484b0 &lt;+3&gt;: sub    esp,0x18
   0x080484b3 &lt;+6&gt;: mov    DWORD PTR [esp],0x80485f0
   0x080484ba &lt;+13&gt;: call   0x8048370 &lt;puts@plt&gt;
=&gt; 0x080484bf &lt;+18&gt;: leave 
   0x080484c0 &lt;+19&gt;: ret
</code></pre></div>
<p><br></p>

<p><strong>• <u>leave 실행 전의 스택 상황</u></strong></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) x/28wx $esp
0xbffff6f0: 0x080485f0 0x080485f8 0xbffff714 0xb7e63280
0xbffff700: 0x00000003 0xb7fff938 0xbffff728 0x080484e4
0xbffff710: 0x080485f8 0x00000003 0x00000001 0x0804831d
0xbffff720: 0xbffff914 0x0000002f 0xbffff758 0x0804850b
0xbffff730: 0x00000001 0x00000002 0xbffff800 0xb7e4942d
0xbffff740: 0xb7fc03c4 0xb7fff000 0x0804856b 0x00000000
0xbffff750: 0x08048560 0x00000000 0x00000000 0xb7e2fa83
(gdb) i r $ebp $esp
ebp            0xbffff708 0xbffff708
esp            0xbffff6f0 0xbffff6f0
</code></pre></div>
<blockquote>
<p>0x080485f0 0x080485f8 0xbffff714 0xb7e63280<br>
0x00000003 0xb7fff938 0xbffff728 : <strong>func2의 stack frame</strong>  </p>

<blockquote>
<p>0x080484e4<br>
0x080485f8 0x00000003 0x00000001 0x0804831d<br>
0xbffff914 0x0000002f 0xbffff758 : <strong>sum의 stack frame</strong>  </p>

<blockquote>
<p>0x0804850b<br>
0x00000001 0x00000002 0xbffff800 0xb7e4942d<br>
0xb7fc03c4 0xb7fff000 0x0804856b 0x00000000<br>
0x08048560 0x00000000 0x00000000 : <strong>main의 stack frame</strong></p>
</blockquote>
</blockquote>
</blockquote>

<p><br></p>

<p><strong>• leave 실행 후의 스택 상황</strong></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) ni
0x080484c0 in func2 ()
(gdb) x/20wx $esp
0xbffff70c: 0x080484e4 0x080485f8 0x00000003 0x00000001
0xbffff71c: 0x0804831d 0xbffff914 0x0000002f 0xbffff758
0xbffff72c: 0x0804850b 0x00000001 0x00000002 0xbffff800
0xbffff73c: 0xb7e4942d 0xb7fc03c4 0xb7fff000 0x0804856b
0xbffff74c: 0x00000000 0x08048560 0x00000000 0x00000000
(gdb) i r $ebp $esp
ebp            0xbffff728 0xbffff728
esp            0xbffff70c 0xbffff70c
</code></pre></div>
<blockquote>
<p>0x080484e4 0x080485f8 0x00000003 0x00000001<br>
0x0804831d 0xbffff914 0x0000002f 0xbffff758 : <strong>sum의 stack frame</strong>  </p>

<blockquote>
<p>0x0804850b 0x00000001 0x00000002 0xbffff800<br>
0xb7e4942d 0xb7fc03c4 0xb7fff000 0x0804856b<br>
0x00000000 0x08048560 0x00000000 0x00000000 : <strong>main의 stack frame</strong></p>
</blockquote>
</blockquote>

<p><strong>Leave</strong> 실행 후에 <strong>func2의 stack frame</strong>이 모두 정리된 것 보이시나여?<br>
그리고 ebp가 sum의 ebp로 바뀌고,<br>
esp도 sum의 esp로 바뀌었습니다.</p>

<p>그리고 <strong>Ret</strong>을 만나면 <strong>0x080484e4로 리턴</strong>해 나머지 sum의 인스트럭션을 실행하고,<br>
끝으로 sum의 stack frame도 정리되고 나머지 main의 인스트럭션을 실행한 후<br>
프로그램을 종료하는 것이겠씀미다아아~</p>

<p>쟈아아아 오늘은 gdb도 써보거 스택에 대해서도 자세히 알아보았눈데,<br>
어떠셔쎄여?<br>
다음 번엔 좀 더 다이나믹한 데이트를 합씨당.<br>
아 물론 데이트 코스는 제가 짭니당. ^ㅠ^
<br></p>

<p><em>다음 포스팅 예고</em></p>

<p><img src="../assets/Post_Images/2017/01/24/gdb_memory_day2/gdb-memory-day2-outro.gif" alt=""></p>

<p>그럼 이만 뿅!</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/umbrain/author/tabris" style="background-image: url(/umbrain/assets/images/author_ico.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/umbrain/author/tabris">taBRis</a></h4>
                
                
                    <p> Into the Brain of taBRis.</p>
                
                <div class="author-meta">
                     
                    <span class="author-link icon-link"><a href="http://tabriz83.github.io/umbrain/"> tabriz83.github.io/umbrain/</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=우리집에 GDB 있는데... 메모리 보고갈래? (2)&amp;url=http://tabriz83.github.io/umbrain/gdb-memory-day2"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://tabriz83.github.io/umbrain/gdb-memory-day2"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://tabriz83.github.io/umbrain/gdb-memory-day2"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/umbrain/assets/images/cover2.jpg)" href="/umbrain/gdb-memory-day1">
            <section class="post">
                <h2>우리집에 GDB 있는데... 메모리 보고갈래? (1)</h2>
                <p>출처 : 우리집에 GDB 있는데... 메모리 보고갈래? (1) - Hackerz on the Ship 들어가기에 앞서......</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/umbrain/">UMBrain :: Into the Brain of taBRis.</a> &copy; 2017</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/umbrain/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/umbrain/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-69281367-1', 'auto');
	    ga('send', 'pageview');

     </script>   
</body>
</html>
